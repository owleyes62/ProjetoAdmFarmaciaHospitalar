<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Projeto Adm Hospitalar</title>
    <!-- Favicon para evitar erro 404 -->
    <link rel="icon" href="data:,">
    <!-- Manifest -->
    <meta name="theme-color" content="#ffffff" />
    <!-- CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/pages/login.css">
    <link rel="stylesheet" href="css/pages/pacientes.css">
    <link rel="stylesheet" href="css/pages/config.css">
    <link rel="stylesheet" href="css/pages/ajuda.css" />
    <link rel="stylesheet" href="css/pages/medicamento.css" />
    <link rel="stylesheet" href="css/pages/entrega.css" />
    <link rel="stylesheet" href="css/pages/prontuario.css">
    <link rel="stylesheet" href="css/pages/atendidos.css">
    <link rel="stylesheet" href="css/pages/relatorio.css">
    <link rel="manifest" href="/manifest.json">
    
    <!-- PWA - Meta tags para melhor suporte -->
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="FarmHospital">
    
    <!-- PWA - √çcones para dispositivos Apple -->
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png">
    
    <!-- PWA - Meta tags adicionais -->
    <meta name="description" content="Sistema de administra√ß√£o para farm√°cia hospitalar">
    <meta name="keywords" content="farm√°cia, hospital, administra√ß√£o, medicamentos">
</head>
<body>
<!-- reCAPTCHA Modal - Aparece assim que o site carrega -->
    <div id="recaptcha-modal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    ">
        <div style="
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        ">
            <h2 style="margin-bottom: 20px; color: #333;">üîí Verifica√ß√£o de Seguran√ßa</h2>
            <p style="margin-bottom: 20px; color: #666;">
                Por favor, confirme que voc√™ n√£o √© um rob√¥ para acessar o sistema:
            </p>
            
            <!-- Widget do reCAPTCHA -->
            <div id="recaptcha-widget" style="display: flex; justify-content: center; margin: 20px 0;"></div>
            
            <button id="verify-button" style="
                background: #4CAF50;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
                opacity: 0.5;
                transition: all 0.3s ease;
            " disabled>
                ‚úÖ Verificar e Entrar
            </button>
            
            <p style="font-size: 12px; color: #999; margin-top: 15px;">
                Sistema protegido por reCAPTCHA do Google
            </p>
        </div>
    </div>

    <!-- Corrigido: removido div duplicado -->
    <div id="app" class="fade-in">
        <!-- O conte√∫do da p√°gina ser√° carregado aqui -->
    </div>
    
    <!-- Supabase SDK (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- Carrega a conex√£o com BD ANTES do app.js -->
    <script src="js/bdConnect.js"></script>
    <!-- Seu script principal -->
    <script type="module" src="js/app.js"></script>

     <!-- reCAPTCHA - Configura√ß√£o e Controle -->
    <script>
        // SUBSTITUA 'SEU_SITE_KEY_AQUI' pela sua chave do Google reCAPTCHA
        const RECAPTCHA_SITE_KEY = '6Lfmz1srAAAAAK1hJXxtYFa_buyJO8edaAAgyr82';
        
        let recaptchaWidget;
        let isRecaptchaVerified = false;
        
        // Fun√ß√£o chamada quando o reCAPTCHA carrega
        function onRecaptchaLoad() {
            recaptchaWidget = grecaptcha.render('recaptcha-widget', {
                'sitekey': RECAPTCHA_SITE_KEY,
                'callback': onRecaptchaSuccess,
                'expired-callback': onRecaptchaExpired,
                'error-callback': onRecaptchaError
            });
        }
        
        // Fun√ß√£o chamada quando reCAPTCHA √© resolvido com sucesso
        function onRecaptchaSuccess(token) {
            isRecaptchaVerified = true;
            const verifyButton = document.getElementById('verify-button');
            verifyButton.disabled = false;
            verifyButton.style.opacity = '1';
            verifyButton.style.cursor = 'pointer';
            console.log('reCAPTCHA verificado com sucesso!');
        }
        
        // Fun√ß√£o chamada quando reCAPTCHA expira
        function onRecaptchaExpired() {
            isRecaptchaVerified = false;
            const verifyButton = document.getElementById('verify-button');
            verifyButton.disabled = true;
            verifyButton.style.opacity = '0.5';
            console.log('reCAPTCHA expirado. Tente novamente.');
        }
        
        // Fun√ß√£o chamada quando h√° erro no reCAPTCHA
        function onRecaptchaError() {
            console.log('Erro no reCAPTCHA. Tente recarregar a p√°gina.');
            alert('Erro na verifica√ß√£o. Por favor, recarregue a p√°gina.');
        }
        
        // Fun√ß√£o para verificar e liberar acesso
        function verifyAndEnter() {
            if (isRecaptchaVerified) {
                // Esconde o modal do reCAPTCHA
                document.getElementById('recaptcha-modal').style.display = 'none';
                // Mostra o conte√∫do principal
                document.getElementById('main-content').style.display = 'block';
                
                console.log('Usu√°rio verificado! Acesso liberado.');
                
                // Opcional: Enviar token para o servidor para valida√ß√£o
                const recaptchaToken = grecaptcha.getResponse(recaptchaWidget);
                console.log('Token reCAPTCHA:', recaptchaToken);
                
                // Aqui voc√™ pode fazer uma requisi√ß√£o para seu servidor
                // para verificar o token no backend se necess√°rio
                
            } else {
                alert('Por favor, complete a verifica√ß√£o reCAPTCHA primeiro.');
            }
        }
        
        // Aguardar carregamento da p√°gina
        window.addEventListener('load', () => {
            // Configurar bot√£o de verifica√ß√£o
            const verifyButton = document.getElementById('verify-button');
            verifyButton.addEventListener('click', verifyAndEnter);
            
            // Carregar reCAPTCHA ap√≥s 1 segundo (para melhor UX)
            setTimeout(() => {
                if (typeof grecaptcha !== 'undefined') {
                    onRecaptchaLoad();
                } else {
                    console.error('reCAPTCHA n√£o carregou. Verifique sua conex√£o.');
                }
            }, 1000);
        });
    </script>

      <!-- PWA - Registro do Service Worker -->
    <script>
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registrado com sucesso:', registration);
                    })
                    .catch((error) => {
                        console.log('Falha ao registrar Service Worker:', error);
                    });
            });
        }
        
        // PWA - Detectar quando o app pode ser instalado
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // Previne o Chrome 67 e anteriores de mostrar automaticamente o prompt
            e.preventDefault();
            // Guarda o evento para usar depois
            deferredPrompt = e;
            
            // Mostra o bot√£o de instala√ß√£o no meio da p√°gina
            const installContainer = document.getElementById('install-container');
            const installButton = document.getElementById('install-button');
            
            if (installContainer && installButton) {
                installContainer.style.display = 'block';
                
                // Adiciona evento de clique no bot√£o
                installButton.addEventListener('click', () => {
                    // Mostra o prompt de instala√ß√£o
                    deferredPrompt.prompt();
                    
                    // Aguarda a escolha do usu√°rio
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('Usu√°rio instalou o PWA');
                            // Esconde o bot√£o ap√≥s instala√ß√£o
                            installContainer.style.display = 'none';
                        } else {
                            console.log('Usu√°rio cancelou a instala√ß√£o');
                        }
                        deferredPrompt = null;
                    });
                });
                
                // Adiciona efeito hover
                installButton.addEventListener('mouseenter', () => {
                    installButton.style.background = '#0056b3';
                });
                
                installButton.addEventListener('mouseleave', () => {
                    installButton.style.background = '#007bff';
                });
            }
            
            console.log('PWA pode ser instalado!');
        });
        
        // PWA - Detectar quando o app foi instalado
        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA foi instalado com sucesso!');
            
            // Esconde o bot√£o de instala√ß√£o ap√≥s instala√ß√£o bem-sucedida
            const installContainer = document.getElementById('install-container');
            if (installContainer) {
                installContainer.style.display = 'none';
            }
        });
    </script>
</body>
</html>